---
title: "practice_markdown"
author: "Emmanuel_Carranza"
date: "06/12/2021"
output: pdf_document
---

# Package, CITATION ?
```{r,echo=}
library(tidyverse)
library(readxl)
library(lubridate)
library(data.table)
library(arsenal)
library(treemap)
```

# BANQUE DE DONNÉES DES VACCINS 
```{r, echo=FALSE}
#J'applique la fonction pour avoir des information sur le fichier local.
vacc_db_info <- file.info("data/raw/covid19vacc.csv")

#Si le fichier n'a pas été mis a jour dans les dernières 24 heures,
#J'applique la fonction download.file pour télécharger la banque de données.
ifelse(difftime(Sys.time(),vacc_db_info$ctime, units = "hours") > 24,
       download.file("https://github.com/owid/covid-19-data/raw/master/public/data/vaccinations/vaccinations.csv", destfile = "data/raw/covid19vacc.csv"),
       "La banque de données à été mise a jour dans les 24 dernières heures")

#Lecture du fichier csv
vax_raw <- read_csv("data/raw/covid19vacc.csv")
```


#MANIPULATION BANQUE DE DONNÉES DES VACCINS
```{r}


#Je change le type de classe de la valeur location pour que ca soit 
#une variable catégorielle.
#Je recode les iso_code des pays qui n'était pas identifié par trois lettres
#Je recode les iso_codes des observations qui ont pour location : une catégorie
#socio-économique.
#Je déselectionne les variables que je considère moins importantes ou
#qui est remplit de NAs.  Par exemple total_boosters qui a surment été crée 
#seulement après la découverte de nouvelle variante néccésitant une 3iem dose.
# Si j'enlève les NAs à la fin, je coupe ma banque de données de 50%
vaxd <- vax_raw %>% 
    mutate(location=factor(location),
        iso_code=recode(iso_code, 
                         "OWID_KOS"="KOS",
                         "OWID_CYN"="CYN",
                         "OWID_SCT"="SCT",
                         "OWID_WLS"="WLS",
                         "OWID_ENG"="ENG",
                         "OWID_NIR"="NIR",
                         "OWID_UMC"="income",
                         "OWID_LIC"="income",
                         "OWID_HIC"="income",
                         "OWID_LMC"="income")) %>% 
    select(-c(total_vaccinations,daily_vaccinations_raw,total_boosters_per_hundred,total_boosters,daily_vaccinations_per_million,daily_people_vaccinated_per_hundred,daily_people_vaccinated,daily_vaccinations)) %>% 
  na.omit() # J'enlève les NA ici parce que trop de ne mettent pas tout les variables à jour quotidiennement mais une fois par semaine ou moins. Alors je vais simplement prendre la dernière observation qui est complète


# Sous ensemble de ceux vaccinés, groupé par pays.
country_vax <- vaxd[vaxd$iso_code %like% "^[a-zA-Z]{3}$", ]

# Seulement la dernière observation de chaque pays
country_vax <- country_vax %>% 
  group_by(location) %>%
slice(which.max(as.Date(date, '%Y/%m/%d')))

```



# Banque de données de vaccinations séparé par continent
```{r}
# Sous ensemble de ceux vacciné, groupé par continent
continent_vax <- vaxd[vaxd$iso_code %like% "OWID", ] %>% 
                mutate(location=factor(location))



#J'enlève l'union européenne
continent_vax <- continent_vax[continent_vax$location %in% c("Africa","Asia","Europe","North America","Oceania","South America","World"), ]

#Je prend seulement la dernière observations de chaque continent.
continent_vax <- continent_vax %>% 
  group_by(location) %>%
slice(which.max(as.Date(date, '%Y/%m/%d')))


```



# BANQUE DE DONNÉES DE POPULATION MONDIALE
```{r}
# J'applique la fonction pour avoir des informations sur le fichier local.
fileinfo_pop <- file.info("data/raw/gapminder_pop.xlsx")

#Si le fichier n'a pas été mis a jour dans les 30 derniers jours,
#J'applique la fonction download.file pour télécharger la banque de données.
ifelse(difftime(Sys.time(),fileinfo_pop$ctime, units = "days" ) > 30 , download.file("https://docs.google.com/spreadsheets/d/14_suWY8fCPEXV0MH7ZQMZ-KndzMVsSsA5HdR-7WqAC0/export?format=xlsx", destfile = "data/raw/gapminder_pop.xlsx"),
       "La banque de données a été mise à jour dans les 30 derniers jours.")


#Lecture du fichier excel pour la population des pays individuellement.
country_pop_raw <- read_xlsx("data/raw/gapminder_pop.xlsx", sheet = 7, range = "A3:KQ200")

#Lecture du même fichier excel mais pour la population par continent.
continent_pop_raw <- read_xlsx("data/raw/gapminder_pop.xlsx", sheet = 7, range = "A202:KQ207")
```

# Manipulation de la banque de données de population mondiale
```{r}
# Je séléctionne les variabes importantes quant à la poulation par pays
country_pop <- country_pop_raw %>% 
    mutate(name=factor(name)) %>%
    select(c(name,`2020.0`, `2021.0`, `2022.0`))

# Je séléctionne les variables importantes quant à la poulation par continent.
continent_pop <- continent_pop_raw %>% 
    select(c(name,`2020.0`, `2021.0`, `2022.0`))


# Je renomme le nom de la colonne pour pouvoir la "merge" avec 
# la banque de données de vaccination.
names(country_pop)[1] <- "location"
names(continent_pop)[1] <- "location"
```




# BANQUE DE DONNÉES "LIFE EXPECTENCY"
# Est-ce que les donnees sont a jour ?
```{r,echo=FALSE}
# J'applique la fonction pour avoir des informations sur le fichier local.
fileinfo_life <- file.info("data/raw/gapminder_lifeexp.xlsx")

#Si le fichier n'a pas été mis a jour dans les 30 derniers jours,
#J'applique la fonction download.file pour télécharger la banque de données.
ifelse(difftime(Sys.time(),fileinfo_pop$ctime, units = "days" ) > 30, download.file("https://docs.google.com/spreadsheets/d/11mulzUH3_cueq-V9D5KIlo9oHE9YYZrUSeVyCin7_rM/export?format=xlsx", destfile = "data/raw/gapminder_lifeexp.xlsx"),
       "La banque de données a été mise à jour dans les 30 derniers jours.")
```

#importation des donnees brute
```{r}
#Lecture du fichier excel pour l'espérance de vie groupé par pays.
life_country_raw <- read_xlsx("data/raw/gapminder_lifeexp.xlsx", sheet = 6, range = "A4:KQ201")

#Lecture du fichier excel pour l'espérance de vie groupé par continent.
life_continent_raw <- read_xlsx("data/raw/gapminder_lifeexp.xlsx", sheet = 6, range = "A203:KQ208")
```

# Manipulation des donnes brutes d'espérance de vie
```{r}
# PAR PAYS, je prend juste 2021 pcq les différence d'une annee a lautre sont minime.
life_country <- life_country_raw %>% 
    mutate(name=factor(name)) %>% 
    select(c(name,`2021.0`)) %>% 
    na.omit()

names(life_country)[1] <- "location" 


# PAR CONTINENT
life_continent <- life_continent_raw %>% 
    mutate(name=factor(name)) %>% 
    select(c(name,`2021.0`)) %>% 
    na.omit()

names(life_continent)[1] <- "location"
  
```


#UNION DE MES BANQUES DE DONNÉES EN FONCTION DES PAYS
```{r}
# Pour merge la population de chaque pays dependant de la date.

country_pop <- country_pop  %>%
  pivot_longer(!location, names_to = "date", values_to = "population") %>% 
  dplyr::mutate(year = str_sub(date, 1, 4))

country_vax <- country_vax %>%
  mutate(year = str_sub(date, end = 4)) %>%
  left_join(., country_pop, by = c("location", "year")) %>%
  select(-c(date.y, year)) %>% 
  select(1,2,3,4,5,6,7,8,9)

total <- merge(country_vax, life_country,by = "location") %>% 
            rename("Life_expectancy" = "2021.0")


tree <- tre

graph <- ggplot(total,aes(x=location,y=value,fill=factor(gender)))+
  geom_bar(stat="identity",position="dodge")+
  scale_fill_discrete(name="Gender",
                      breaks=c(1, 2),
                      labels=c("Male", "Female"))+
  xlab("Beverage")+ylab("Mean Percentage")


```


# Union de mes banques de données en fonction des continent
```{r}
continent <- continent_vax %>% 
  fct_collapse(continent_vax$location,
                  "The Americas" = c("North America", "South America"))

class(continent_vax$location)
```

