---
title: "Analyse des banques de données"
description: | 
  Venant de World in Data & Gapminder
date: "`r Sys.Date()`"
# Modifier les détails que vous voulez
author:
  - first_name: "Emmanuel"
    last_name: "Carranza"
    url: https://github.com/emmanuel-carranza
    affiliation: Université de Montréal
    affiliation_url: https://admission.umontreal.ca/programmes/microprogramme-de-1er-cycle-en-analyse-des-megadonnees-en-sciences-humaines-et-sociales/structure-du-programme/
    orcid_id: 0000-0003-2651-6737
# Changer pour votre propre URL si jamais quelqu'un vous cite!
citation_url: https://fas1002.github.io/FAS1002_projet-final
# Inclure les références que vous utilisez dans vos rapports
# dans un fichier biblio.bib. Je conseille Zotero pour construire
# ce fichier ou d'utiliser le package citr dans RStudio.
# Installation: devtools::install_github("crsh/citr")
bibliography: references.bib
output: distill::distill_article
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(tidyverse)
library(data.table)
library(readxl)
library(rmarkdown)
library(RColorBrewer)
```

```{r, include=FALSE}
vax_raw <- read_csv("data/raw/covid19vacc.csv") #Données brutes

obs_raw <- nrow(vax_raw)

na_vax_raw <- sum(is.na(vax_raw)) #Nombre de données manquantes données manquantes

vaxd_continent <- vax_raw %>% 
  subset(iso_code %like% "OWID")

unique_cont <- unique(vaxd_continent$location)
#Il y a des intrus dans ce qui est senser être des continents.

vaxd <- vax_raw %>% 
    mutate(location=factor(location), #change la classe de la variables
        iso_code=recode(iso_code,
                         "OWID_KOS"="KOS",
                         "OWID_CYN"="CYN",
                         "OWID_SCT"="SCT",
                         "OWID_WLS"="WLS",
                         "OWID_ENG"="ENG",
                         "OWID_NIR"="NIR",
                         "OWID_UMC"="income",
                         "OWID_LIC"="income",
                         "OWID_HIC"="income",
                         "OWID_LMC"="income"))
# Recode iso_code pour que certains pays aient un iso_code à 3 lettres,
# ainsi que les locations comme 'High Income' ou 'Low Income'.


vaxd_country <- vaxd %>% 
  subset(iso_code %like% "^[a-zA-Z]{3}$")
#sous-groupe des pays qui ont un iso_code à 3 lettres

unique_country <- length(unique(vaxd_country$location))
#235 pays ou nations uniques

vax_country_entries <- vaxd_country %>% 
   group_by(location) %>% 
    summarize(count=n()) %>%   
    arrange(desc(count))

vax_country_entries 
#Ils sont tous entre 320 et 383 entrées.



vaxd_continent <- vaxd %>%
  group_by(location) %>% 
  subset(location %in% c("Africa","Asia","Europe","North America","Oceania","South America","World"))

unique(vaxd_continent$location)
#J'ai tout les continents que je devrais avoir !


first_date <- vaxd %>% 
          slice(which.min(as.Date(date, '%Y/%m/%d')))
first_date$date
#Le Denmark à fait la première entrée 2020-12-01


vax_cont_entries <- vaxd_continent %>% 
   group_by(location) %>% 
    summarize(count=n()) %>%   
    arrange(desc(count))

denmark_count <- vax_country_entries %>% 
  filter(location == "Denmark") %>%
  select("count")


vax_cont_entries 
#Ils sont tous entre 320 et 383 entrées.
  
raw_pop_country <- read_xlsx("data/raw/gapminder_pop.xlsx",
                             sheet = 7, range = "A3:KQ200")

raw_pop_continent <- read_xlsx("data/raw/gapminder_pop.xlsx",
                               sheet = 7, range = "A202:KQ207")


unique(raw_pop_continent$name) 
#Manque Océanie et l'amérique est en deux

unique(raw_pop_country$name) 
#J'ai 197 pays

sum(is.na(vaxd_continent))
#beaucoup de NA's juste pour les continent aussi
```

À fin de pouvoir explorer, analyser et visualiser les données de vaccinations, j'ai dû les regarder de très près. En effet on constate `r na_vax_raw` observations manquantes parmis les `r obs_raw` compilées. Après un peu de ménage, je peux compter `r unique_country` pays ou nations qui on contribués aux données. Noté que ce chiffre est plus élevé que le nombre de pays sur terre parce que certains sont des territoires appartenant à certaines nations qui sont situé dans un autre pays ou sur une ile.

Parmis ces nations, on compte une moyenne 298 jours de communications par pays depuis le 1er décembre 2020. C'est le Denmark qui enchaine le bal avec son premier vaccin à un citoyen (suite aux phases d'essaies). Ce qui fait aussi du `r first_date$location` le pays avec le plus d'entrées individuels à `r denmark_count`. Il est suivit de proche par la Norvege, la Lettonie, les États-Unis et le Canada.

On constate des grosses et petites différences entre les pourcentages de gens vaccinés par pays que Our World In Data nous donne et ceux que j'ai calculé moi mêmes

```{r, layout = "l-page"}
big_diff <- read_csv("data/processed/big_diff.csv")
paged_table(big_diff)
```
La colonne "Percentage" est celle que j'ai calculé en prennant le nombre total de vaccinations par pays divisé par la population total du pays. La colonne "difference" nous donne la différence de pourcentage constaté. Noté que le pourcentage peu effectivement dépasser le 100% puisque le nombre de vaccins administré va certainement dépasser celui de la population si on recoit 2 doses et plus pour chacun.


Les données de vaccinations contiennent tout les continents, avec l'Amérique séparée en deux, ainsi qu'une catégorie globale pour le total appellé 'WORLD'. Cependant les données de population ou d'espérance de vie de Gapminder ne contiennent aucune information pour l'Océanie et englobe l'Amérique dans un tout. J'ai décidé de webscrapé manuellement les données pour la population et l'espérance de vie de l'Amérique du Nord et du Sud individuellement pour compléter un peu le manque.

De plus, les données de Gapminder nous donne de l'information sur beaucoup moins de pays que ceux des vaccins.Encore une fois, je pense que c'est parce que certains sont des territoires ou petite îles apartenant à des nations. C'est pour cela que lors de la combinaison des banques de données, tout les pays ou nations qui ne sont pas dans les trois ne sont pas prit en considération.


Après de nombreuse manipulation que vous pouvez lire sur la page [3-manipulation](3-manipulation.html), j'ai réussis a épurer le tout pour visualiser ci-dessous.


### Les plus grand pays

```{r}
country_vax <- read_csv("data/processed/country_vax.csv")

biggest_countries <- country_vax[order(as.integer(country_vax$population),
                                    decreasing = TRUE), ] %>%
                                      head(10)

graph2 <- ggplot(biggest_countries,
                 aes(x= reorder(paste(location, pop_text),population),
                      y= people_fully_vaccinated_per_hundred, fill=location))+
        geom_bar(stat="identity", show.legend=FALSE)+
        scale_fill_brewer(palette="Spectral")+
        geom_text(aes(label = paste0(people_fully_vaccinated_per_hundred,"%")),
                    hjust = -0.1)+
        labs(x = "Pays & taille de population ", y = "Ayant reçu 2 doses",
            title = "Vaccinations pour les pays les plus peuplés classé par taille",
            caption = "Data source: Our World In Data & Gapminder")+
        expand_limits(y = 100)+
        theme_minimal()+
        coord_flip()
graph2
```
Ce premier graphique nous donne un aperçu des données de vaccinations pour les 10 plus grandes nations au monde. Le seul pays en Afrique, le Nigère se trouve à moins de 2% de vaccinations à ce jour (dec-2021). Mon hypothèse de départ est que la taille de la population dois avoir un effet sur la performance de vaccinations d'une population. Mais si on regarde la Chine ou L'Inde avec des populations de plus d'un milliard de personne : ils ont quand même réussit à accomplir beaucoup en peu de temps.



### Les continents
```{r}
continent_vax <- read_csv("data/processed/continent_vax.csv")
graph_cont <- ggplot(continent_vax,
                 aes(x= reorder(paste(location, pop_text),population),
                      y= people_fully_vaccinated_per_hundred, fill=location))+
        geom_bar(stat="identity", show.legend=FALSE)+
        scale_fill_brewer(palette="Spectral")+
        geom_text(aes(label = paste0(people_fully_vaccinated_per_hundred,"%")),
                    hjust = -0.1)+
        labs(x = "Continent & taille de population", y = "Ayant reçu 2 doses",
            title = "Pourcentage de vaccinations par continent",
            caption = "Data source: Our World In Data & Gapminder")+
        expand_limits(y = 100)+
        theme_minimal()+
        coord_flip()
graph_cont
```
Ce graphique est claire et simple. Moins de 50% de la population à reçu deux doses du vaccin. Le plus marquant ici est encore le continent Africain qui a un taux beaucoup trop faible.

### Basse espérance de vie
```{r}
lower_life_exp <- country_vax[order(as.integer(country_vax$life_expectancy),
                                    decreasing = FALSE), ] %>%
                                      head(10)

graph <- ggplot(lower_life_exp,
                 aes(x= reorder(paste(location, life_expectancy),people_fully_vaccinated_per_hundred),
                      y= people_fully_vaccinated_per_hundred, fill=location))+
        geom_bar(stat="identity", show.legend=FALSE)+
        scale_fill_brewer(palette="Spectral")+
        geom_text(aes(label = paste0(people_fully_vaccinated_per_hundred,"%")),
                    hjust = -0.1)+
        labs(x = "Pays et espérance de vie en années", y = "pourcentage ayant reçu 2 doses",
            title = "Vaccinations pour les pays avec espérance de vie la plus basse",
            caption = "Data source: Our World In Data & Gapminder")+
        expand_limits(y = 100)+
        theme_minimal()+
        coord_flip()
graph
```
Le seul pays qui n'est pas en Afrique ici c'est Papouasie-Nouvelle-Guinée. Plus ca avance plus ca va mal. La chose qu'ils ont tous en commmun c'est une espérance de vie assez basse comparé au reste du monde.Si une chose qui est certaine, c'est que le facteur socio-économique d'un environnement a une influence sur l'espérance de vie(CITATION CHETTY, 2014). Les conséquences de l'emprise socio-économique sont perçu aussi a travers des données de vaccinations.


### Régression linéaire

```{r}
ok <- read_csv("data/processed/country_vax.csv")

lm_ok <- lm(population ~ people_fully_vaccinated_per_hundred, ok)

summary (lm_ok)

linear_reg <- ggplot(country_vax, aes(x=population, 
                         y=people_fully_vaccinated_per_hundred))+
          geom_point()+
          geom_smooth(formula = y ~ log(x), method = "lm",
                      color = "#FFBF71")+
          scale_x_continuous(trans = "log2")+
          labs(x = "Pourcentage de citoyen d'un pays aillant reçu 2 doses",
               y = "Temps sur échelle logarithmique",
          title = "Taille de population VS pourcentage de vaccination à 2 dose")+
          geom_text(aes(label=ifelse(population>1000000000,
              as.character(location),'')),hjust=0.5,vjust=-1)

linear_reg
```
Call:
lm(formula = population ~ people_fully_vaccinated_per_hundred, 
    data = ok)

Residuals:
       Min         1Q     Median         3Q        Max 
 -59546397  -44290300  -31967563   -7886898 1388357550 

Coefficients:
                                    Estimate Std. Error t value Pr(>|t|)
(Intercept)                         31739236   21644963   1.466    0.144
people_fully_vaccinated_per_hundred   323619     437924   0.739    0.461

Residual standard error: 158100000 on 169 degrees of freedom
Multiple R-squared:  0.003221,	Adjusted R-squared:  -0.002677 
F-statistic: 0.5461 on 1 and 169 DF,  p-value: 0.4609

### Anova

```{r}
anova_df <- country_vax %>% 
    select(c("location","total_vaccinations","population")) %>% 
    mutate(location=factor(location))


anova_df <- stack(anova_df)

anova(lm(values ~ ind, anova_df))
```

Null hypothese : Ya pas de difference entre les pays
Rejet null hypo : Ya une difference entre les pays.

A null hypothesis is a type of hypothesis used in statistics that proposes that there is no difference between certain characteristics of a population 

The p-value is greater than the threshold (0.05) meaning that the null hypothesis cannot be rejected and there is no significant association between the level of electricity consumed and the carbon dioxide emitted.

Analysis of Variance Table

Response: values
           Df     Sum Sq    Mean Sq F value Pr(>F)
ind         1 1.2872e+15 1.2872e+15  0.0356 0.8505
Residuals 340 1.2302e+19 3.6182e+16  

